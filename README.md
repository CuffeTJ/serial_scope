# Serial_Scope_SJTU ä½¿ç”¨ä¸å¼€å‘æ–‡æ¡£

> åŸºäº PyQt5 å’Œ pyqtgraph çš„å››é€šé“ä¸²å£æ•°æ®å®æ—¶æ˜¾ç¤ºå·¥å…·  
> ç‰ˆæœ¬ï¼š1.0  
> æœ€åæ›´æ–°ï¼š2026-01-05

---

## ğŸ“‘ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [è¿è¡Œç¯å¢ƒä¸ä¾èµ–](#2-è¿è¡Œç¯å¢ƒä¸ä¾èµ–)
3. [ä»£ç ç»“æ„ä¸æ¨¡å—è¯´æ˜](#3-ä»£ç ç»“æ„ä¸æ¨¡å—è¯´æ˜)
4. [é€šä¿¡åè®®è¯´æ˜](#4-é€šä¿¡åè®®è¯´æ˜)
5. [ç•Œé¢æ“ä½œæµç¨‹](#5-ç•Œé¢æ“ä½œæµç¨‹)
6. [æ‰©å±•ä¸ä¿®æ”¹æŒ‡å—](#6-æ‰©å±•ä¸ä¿®æ”¹æŒ‡å—)
7. [å¸¸è§é—®é¢˜ä¸è°ƒè¯•](#7-å¸¸è§é—®é¢˜ä¸è°ƒè¯•)
8. [ç³»ç»Ÿé™åˆ¶](#8-ç³»ç»Ÿé™åˆ¶)
9. [å¼€å‘å»ºè®®](#9-å¼€å‘å»ºè®®)

---

## 1. é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®ï¼ˆ**Serial_Scope_SJTU**ï¼‰æ˜¯ä¸€æ¬¾åŸºäº **PyQt5** ä¸ **pyqtgraph** å¼€å‘çš„é«˜æ€§èƒ½å››é€šé“ä¸²å£ç¤ºæ³¢å™¨ã€‚æ ¸å¿ƒåŠŸèƒ½æ¶µç›–ä¸²å£æ•°æ®å¸§çš„å®æ—¶é‡‡é›†ã€è§£æä¸æ³¢å½¢ç»˜åˆ¶ï¼ŒåŒæ—¶æ”¯æŒä¸‹ä½æœºå‚æ•°é…ç½®åŠæ•°æ®æŒä¹…åŒ–å­˜å‚¨ã€‚

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- âœ… **å®æ—¶æ³¢å½¢ç»˜åˆ¶**ï¼šå››é€šé“æ•°æ®çš„é«˜é€Ÿé‡‡é›†ä¸å¯è§†åŒ–å±•ç¤º
- âœ… **å‚æ•°é…ç½®äº¤äº’**ï¼šæ”¯æŒé€šè¿‡ä¸²å£å‘é€ 25 å­—èŠ‚é…ç½®å¸§è‡³ä¸‹ä½æœº
- âœ… **å¤šé‡‡æ ·ç‡é€‚é…**ï¼šæ”¯æŒ 2KHz/1KHz/500Hz/250Hz é‡‡æ ·ç‡åˆ‡æ¢åŠç³»æ•°è‡ªåŠ¨åŒ¹é…
- âœ… **åŸå§‹æ•°æ®ç›‘æ§**ï¼šå®æ—¶ç›‘è§†æ¥æ”¶ç¼“å†²åŒºçš„åŸå§‹åå…­è¿›åˆ¶å­—èŠ‚æµ
- âœ… **æ•°æ®æŒä¹…åŒ–**ï¼šæ”¯æŒå°†è§£æåçš„æµ®ç‚¹æ•°æ®ä¿å­˜ä¸º CSV æ ¼å¼ï¼ˆ.txt åç¼€ï¼‰

---

## 2. è¿è¡Œç¯å¢ƒä¸ä¾èµ–

### 2.1 Python ç‰ˆæœ¬

- **Python 3.7+** ï¼ˆæ¨è Python 3.8 æˆ–ä»¥ä¸Šï¼‰

### 2.2 ä¾èµ–åŒ…

```bash
pip install pyserial pyqt5 pyqtgraph numpy
```

| åŒ…å | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|------|---------|------|
| `pyserial` | â‰¥ 3.0 | ä¸²å£é€šä¿¡ |
| `pyqt5` | â‰¥ 5.12 | å›¾å½¢ç•Œé¢æ¡†æ¶ |
| `pyqtgraph` | â‰¥ 0.11 | å®æ—¶æ•°æ®ç»˜å›¾ |
| `numpy` | â‰¥ 1.16 | æ•°å€¼è®¡ç®— |

### 2.3 æ“ä½œç³»ç»Ÿ

- âœ… Windows 7/10/11
- âœ… Linuxï¼ˆéœ€è¦ä¸²å£è®¿é—®æƒé™ï¼‰
- âœ… macOSï¼ˆå·²å¯ç”¨é«˜DPIç¼©æ”¾é€‚é…ï¼‰

> **æ³¨æ„**ï¼šåœ¨ Linux/macOS ä¸Šè¿è¡Œæ—¶ï¼Œå¯èƒ½éœ€è¦å°†ç”¨æˆ·æ·»åŠ åˆ°ä¸²å£ç”¨æˆ·ç»„ï¼š
> ```bash
> sudo usermod -a -G dialout $USER  # Linux
> ```

---

## 3. ä»£ç ç»“æ„ä¸æ¨¡å—è¯´æ˜

### 3.1 å…¨å±€å¸¸é‡

```python
FRAME_LEN = 40      # æ¯å¸§æ•°æ®é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰
BAUD_RATE = 1000000 # ä¸²å£æ³¢ç‰¹ç‡ï¼ˆ1 Mbpsï¼‰

# é‡‡æ ·é¢‘ç‡æ˜ å°„è¡¨ï¼ˆé¢‘ç‡åç§° â†’ gå€¼ï¼‰
FREQ_G_MAP = {
    "2KHz": 0,
    "1KHz": 1,
    "500Hz": 2,
    "250Hz": 3
}
```

| å¸¸é‡å | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `FRAME_LEN` | 40 | å•å¸§æ•°æ®åŒ…é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰ |
| `BAUD_RATE` | 1000000 | ä¸²å£é€šä¿¡é€Ÿç‡ï¼ˆ1 Mbpsï¼‰ |
| `FREQ_G_MAP` | dict | é‡‡æ ·é¢‘ç‡ä¸ç³»æ•°ç´¢å¼•æ˜ å°„è¡¨ |

### 3.2 æ ¸å¿ƒç±»è¯´æ˜

#### 3.2.1 SerialThread - ä¸²å£é€šä¿¡çº¿ç¨‹

**èŒè´£**ï¼šè´Ÿè´£åº•å±‚ä¸²å£é€šä¿¡ä»»åŠ¡ï¼Œé‡‡ç”¨ç‹¬ç«‹çº¿ç¨‹æ¶æ„ä»¥ç¡®ä¿ UI å“åº”æµç•…æ€§ã€‚

**å…³é”®å±æ€§**ï¼š

| å±æ€§å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `serial_port` | `serial.Serial` | PySerial ä¸²å£å®ä¾‹ |
| `is_running` | `bool` | çº¿ç¨‹è¿è¡ŒçŠ¶æ€æ ‡å¿—ä½ |
| `buffer` | `bytearray` | ç¯å½¢æ¥æ”¶ç¼“å†²åŒº |
| `current_coeffs` | `list[float]` | å½“å‰å½’ä¸€åŒ–ç³»æ•°æ•°ç»„ [nf, nf, na, na] |

**å…³é”®æ–¹æ³•**ï¼š

```python
def open_port(port_name: str) -> bool
    """åˆå§‹åŒ–ä¸²å£è¿æ¥å¹¶å¯åŠ¨æ¥æ”¶çº¿ç¨‹"""
    
def send_data(data_bytes: bytes) -> None
    """å‘ä¸‹ä½æœºå‘é€å­—èŠ‚æµæ•°æ®"""
    
def update_frequency_gain(g: int) -> None
    """æ›´æ–°é¢‘ç‡å¢ç›Šç³»æ•°ï¼ˆg=0~3ï¼‰"""
    
def run(self) -> None
    """çº¿ç¨‹ä¸»å¾ªç¯ï¼šæ‰§è¡Œæ•°æ®æ¥æ”¶ä¸å¸§è§£æ"""
```

**æ•°æ®è§£ææµç¨‹**ï¼š

1. è¯»å–ä¸²å£ç¼“å†²åŒºæ•°æ®ï¼ŒåŸºäºå¸§å¤´ `0xAA` æ‰§è¡Œå¸§åŒæ­¥
2. æˆªå–å®Œæ•´çš„ 40 å­—èŠ‚æ•°æ®å¸§
3. æŒ‰åè®®åç§»é‡æå–å››é€šé“åŸå§‹æ•´å‹æ•°æ®
4. åº”ç”¨å½“å‰ç³»æ•° `current_coeffs` æ‰§è¡Œå½’ä¸€åŒ–è¿ç®—
5. é€šè¿‡ `data_received_signal` ä¿¡å·åˆ†å‘å¤„ç†åçš„æ•°æ®

**æ•°æ®æå–è§„åˆ™**ï¼š

| é€šé“ | å­—èŠ‚èŒƒå›´ | å­—èŠ‚æ•° | æ•°æ®ç±»å‹ | ç³»æ•° |
|------|---------|-------|---------|------|
| CH1 | 3-13 (frame[3:14]) | 11 | å¤§ç«¯æ— ç¬¦å·æ•´æ•° | nf |
| CH2 | 14-24 (frame[14:25]) | 11 | å¤§ç«¯æ— ç¬¦å·æ•´æ•° | nf |
| CH3 | 25-31 (frame[25:32]) | 7 | å¤§ç«¯æ— ç¬¦å·æ•´æ•° | na |
| CH4 | 32-38 (frame[32:39]) | 7 | å¤§ç«¯æ— ç¬¦å·æ•´æ•° | na |

#### 3.2.2 MainWindow - ä¸»ç•Œé¢ç±»

**èŒè´£**ï¼šæ„å»ºå›¾å½¢ç”¨æˆ·ç•Œé¢ (GUI)ï¼Œç»Ÿç­¹æ•°æ®æ˜¾ç¤ºä¸ç”¨æˆ·äº¤äº’é€»è¾‘ã€‚

**ç•Œé¢å¸ƒå±€**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ§åˆ¶é¢æ¿      â”‚   æ³¢å½¢æ˜¾ç¤ºåŒº             â”‚
â”‚  (380px å›ºå®š)  â”‚   (pyqtgraph ç»˜å›¾æ§ä»¶)   â”‚
â”‚                â”‚                          â”‚
â”‚  - ä¸²å£è¿æ¥    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  - é‡‡æ ·é¢‘ç‡è®¾ç½®â”‚   â”‚ CH1 (é»„è‰²)      â”‚   â”‚
â”‚  - æ•°æ®ä¿å­˜    â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  - æ¥æ”¶æ•°æ®    â”‚   â”‚ CH2 (ç»¿è‰²)      â”‚   â”‚
â”‚  - å‚æ•°é…ç½®    â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚    (HEX)      â”‚   â”‚ CH3 (é’è‰²)      â”‚   â”‚
â”‚                â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚                â”‚   â”‚ CH4 (æ´‹çº¢)      â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜
```

**æ•°æ®æµç®¡ç†**ï¼š

- **å†å²ç¼“å†²**ï¼šä½¿ç”¨ `deque` ç»´æŠ¤å„é€šé“å†å²æ•°æ®ï¼ˆé»˜è®¤å®¹é‡ **1000 ç‚¹**ï¼‰
- **ä¸´æ—¶ç¼“å†²**ï¼š`temp_buffer` æš‚å­˜æ¥æ”¶æ•°æ®åŒ…ï¼Œç”±å®šæ—¶å™¨æ‰¹é‡åˆ·æ–°è‡³ UI
- **åˆ·æ–°æœºåˆ¶**ï¼š50ms å®šæ—¶å™¨è§¦å‘ç•Œé¢é‡ç»˜ï¼ˆçº¦ **20 FPS**ï¼‰

**å…³é”®ç»„ä»¶**ï¼š

| ç»„ä»¶å | ç±»å‹ | åŠŸèƒ½ |
|--------|------|------|
| `combo_ports` | QComboBox | ä¸²å£é€‰æ‹©ä¸‹æ‹‰æ¡† |
| `combo_freq` | QComboBox | é‡‡æ ·é¢‘ç‡é€‰æ‹© |
| `txt_raw_display` | QPlainTextEdit | åŸå§‹æ•°æ®æ˜¾ç¤ºï¼ˆæœ€è¿‘5å¸§ï¼‰ |
| `graph_widget` | GraphicsLayoutWidget | å››é€šé“æ³¢å½¢ç»˜å›¾åŒº |
| `send_structure` | list | 25å­—èŠ‚å‚æ•°ç»“æ„ |

---

## 4. é€šä¿¡åè®®è¯´æ˜

### 4.1 ä¸‹è¡Œåè®®ï¼ˆä¸Šä½æœº â†’ ä¸‹ä½æœºï¼‰

**æ•°æ®åŒ…ç»“æ„**ï¼šå®šé•¿ 25 å­—èŠ‚

**å­—èŠ‚åˆ†å¸ƒ**ï¼š

| å­—èŠ‚ç´¢å¼• | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|---------|------|-------|------|
| B1 (0) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B2 (1) | **å›ºå®š** | **0x24** | åè®®æ ‡è¯† |
| B3 (2) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B4 (3) | **å›ºå®š** | **0x25** | åè®®æ ‡è¯† |
| B5 (4) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B6 (5) | **å›ºå®š** | **0x26** | åè®®æ ‡è¯† |
| B7 (6) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B8 (7) | **å›ºå®š** | **0x27** | åè®®æ ‡è¯† |
| B9 (8) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B10 (9) | **å›ºå®š** | **0x28** | åè®®æ ‡è¯† |
| B11 (10) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B12 (11) | **å›ºå®š** | **0x29** | åè®®æ ‡è¯† |
| B13 (12) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B14 (13) | **å›ºå®š** | **0x2A** | åè®®æ ‡è¯† |
| B15 (14) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B16 (15) | **å›ºå®š** | **0x2B** | åè®®æ ‡è¯† |
| B17 (16) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B18 (17) | **å›ºå®š** | **0x2C** | åè®®æ ‡è¯† |
| B19 (18) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B20 (19) | **å›ºå®š** | **0x2D** | åè®®æ ‡è¯† |
| B21 (20) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |
| B22 (21) | **å›ºå®š** | **0x2E** | åè®®æ ‡è¯† |
| B23-B25 (22-24) | å¯é…ç½® | 0x00 | ç”¨æˆ·å‚æ•° |

**å›ºå®šå­—èŠ‚ç´¢å¼•ï¼ˆ0-basedï¼‰**ï¼š`1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21`  
**å¯é…ç½®å­—èŠ‚ç´¢å¼•ï¼ˆ0-basedï¼‰**ï¼š`0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 23, 24`ï¼ˆå…± **14 ä¸ª**ï¼‰

### 4.2 ä¸Šè¡Œåè®®ï¼ˆä¸‹ä½æœº â†’ ä¸Šä½æœºï¼‰

**æ•°æ®å¸§ç»“æ„**ï¼šå®šé•¿ 40 å­—èŠ‚

| å­—èŠ‚ç´¢å¼• | å†…å®¹ | è¯´æ˜ |
|---------|------|------|
| 0 | 0xAA | **å¸§å¤´æ ‡è¯†** |
| 1-2 | é¢„ç•™ | ä¿ç•™å­—èŠ‚ |
| 3-13 | CH1 æ•°æ® | 11å­—èŠ‚å¤§ç«¯æ— ç¬¦å·æ•´æ•° |
| 14-24 | CH2 æ•°æ® | 11å­—èŠ‚å¤§ç«¯æ— ç¬¦å·æ•´æ•° |
| 25-31 | CH3 æ•°æ® | 7å­—èŠ‚å¤§ç«¯æ— ç¬¦å·æ•´æ•° |
| 32-38 | CH4 æ•°æ® | 7å­—èŠ‚å¤§ç«¯æ— ç¬¦å·æ•´æ•° |
| 39 | 0xBB | **å¸§å°¾æ ‡è¯†** |

**å¸§åŒæ­¥æœºåˆ¶**ï¼šåŸºäºå¸§å¤´ `0xAA` å®ç°å¸§å¯¹é½ï¼ˆæ¨èç»“åˆ `0xBB` å¸§å°¾æ ¡éªŒä»¥å¢å¼ºé²æ£’æ€§ï¼‰ã€‚

### 4.3 æ•°æ®å¤„ç†å…¬å¼

**å½’ä¸€åŒ–è®¡ç®—**ï¼š

```python
processed_value = raw_integer / current_coeff
```

**ç³»æ•°è®¡ç®—å‡½æ•°**ï¼š

```python
def calculate_coeffs(g):
    """
    æ ¹æ®é¢‘ç‡æ¡£ä½è®¡ç®—å½’ä¸€åŒ–ç³»æ•°
    
    å‚æ•°:
        g (int): é¢‘ç‡æ¡£ä½ (0~3)
                 0: 2KHz, 1: 1KHz, 2: 500Hz, 3: 250Hz
    
    è¿”å›:
        tuple: (nf, na)
               nf: CH1/CH2 ä½¿ç”¨çš„ç³»æ•°
               na: CH3/CH4 ä½¿ç”¨çš„ç³»æ•°
    """
    nf = (21 * (2 ** (6 * g + 51))) / 125.0
    na = 2 ** (24 + 6 * g)
    return nf, na
```

**ç³»æ•°æ•°å€¼è¡¨**ï¼š

| é¢‘ç‡ | g å€¼ | nf (CH1/CH2) | na (CH3/CH4) |
|------|------|--------------|--------------|
| 2KHz | 0 | 4.70e+16 | 1.68e+07 |
| 1KHz | 1 | 1.20e+18 | 1.07e+09 |
| 500Hz | 2 | 3.07e+19 | 6.87e+10 |
| 250Hz | 3 | 7.86e+20 | 4.40e+12 |

---

## 5. ç•Œé¢æ“ä½œæµç¨‹

### 5.1 è¿æ¥ä¸²å£

1. ç‚¹å‡» **"åˆ·æ–°"** æŒ‰é’®è·å–ç³»ç»Ÿå¯ç”¨ä¸²å£åˆ—è¡¨
2. åœ¨ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©ç›®æ ‡ä¸²å£ï¼ˆå¦‚ `COM3`ã€`/dev/ttyUSB0`ï¼‰
3. ç‚¹å‡» **"æ‰“å¼€ä¸²å£"** æŒ‰é’®
   - æˆåŠŸï¼šæŒ‰é’®å˜ä¸ºç»¿è‰² **"å…³é—­"**ï¼Œå¼€å§‹æ¥æ”¶æ•°æ®
   - å¤±è´¥ï¼šå¼¹å‡ºé”™è¯¯æç¤ºå¯¹è¯æ¡†

### 5.2 è®¾ç½®å‚æ•°

#### æ­¥éª¤ 1ï¼šè®¾ç½®é‡‡æ ·é¢‘ç‡

1. åœ¨ **"é‡‡æ ·é¢‘ç‡è®¾ç½®"** åŒºåŸŸé€‰æ‹©é¢‘ç‡ï¼ˆ2KHz / 1KHz / 500Hz / 250Hzï¼‰
2. ç‚¹å‡» **"æ›´æ–°è®¡ç®—ç³»æ•°"** æŒ‰é’®
   - ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—å¹¶æ›´æ–° nf å’Œ na ç³»æ•°
   - æ§åˆ¶å°è¾“å‡ºï¼š`æ›´æ–°ç³»æ•° g=X: NF=Y, NA=Z`

#### æ­¥éª¤ 2ï¼šé…ç½® 25 å­—èŠ‚å‚æ•°

1. åœ¨å‚æ•°é…ç½®ç½‘æ ¼ä¸­ç¼–è¾‘ **å¯ä¿®æ”¹çš„å­—èŠ‚å€¼**ï¼ˆåå…­è¿›åˆ¶ï¼Œ2ä½ï¼‰
   - ç°è‰²èƒŒæ™¯ï¼šå›ºå®šå­—èŠ‚ï¼ˆä¸å¯ç¼–è¾‘ï¼‰
   - ç™½è‰²èƒŒæ™¯ï¼šå¯é…ç½®å­—èŠ‚ï¼ˆå¯è¾“å…¥ 00-FFï¼‰
2. ç‚¹å‡» **"å‘é€é…ç½®"** æŒ‰é’®
   - æ•°æ®å‘é€åˆ°ä¸‹ä½æœº
   - è‡ªåŠ¨è§¦å‘ç³»æ•°æ›´æ–°

### 5.3 æ•°æ®ä¿å­˜

#### å¼€å§‹ä¿å­˜

1. ç‚¹å‡» **"ä¿å­˜"** æŒ‰é’®
2. é€‰æ‹©æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼ˆé»˜è®¤æ‰©å±•å `.txt`ï¼‰
3. æŒ‰é’®çŠ¶æ€å˜ä¸º **"ä¿å­˜ä¸­..."** å¹¶ç¦ç”¨ï¼Œ**"åœæ­¢ä¿å­˜"** æŒ‰é’®å˜ä¸ºçº¢è‰²å¯ç”¨

#### åœæ­¢ä¿å­˜

1. ç‚¹å‡» **"åœæ­¢ä¿å­˜"** æŒ‰é’®
2. æ–‡ä»¶è‡ªåŠ¨å…³é—­ï¼ŒæŒ‰é’®çŠ¶æ€æ¢å¤

**ä¿å­˜æ ¼å¼**ï¼ˆCSVï¼‰ï¼š

```csv
CH1,CH2,CH3,CH4
0.12345678, 0.23456789, 0.34567890, 0.45678901
0.12345679, 0.23456790, 0.34567891, 0.45678902
...
```

### 5.4 ç›‘æ§åŸå§‹æ•°æ®

- **æ¥æ”¶æ•°æ®åŒºåŸŸ**ï¼šå®æ—¶æ˜¾ç¤ºæœ€è¿‘ **5 å¸§**åŸå§‹æ•°æ®ï¼ˆåå…­è¿›åˆ¶æ ¼å¼ï¼‰
- æ ¼å¼ç¤ºä¾‹ï¼š
  ```
  AA 00 00 1A 2B 3C 4D ... (40å­—èŠ‚)
  AA 00 00 1A 2B 3C 4E ... (40å­—èŠ‚)
  ```

---

## 6. æ‰©å±•ä¸ä¿®æ”¹æŒ‡å—

### 6.1 æ·»åŠ æ–°é€šé“

**æ­¥éª¤**ï¼š

1. **ä¿®æ”¹å¸¸é‡**ï¼ˆå¦‚æœéœ€è¦ï¼‰
   ```python
   FRAME_LEN = 50  # å¢åŠ å¸§é•¿åº¦
   ```

2. **æ‰©å±•æ•°æ®è§£æ** - åœ¨ `SerialThread.run()` ä¸­æ·»åŠ ï¼š
   ```python
   val5 = int.from_bytes(frame[39:46], byteorder='big', signed=False)
   processed_data.append(val5 / self.current_coeffs[4])
   ```

3. **æ·»åŠ æ•°æ®ç¼“å†²åŒº** - åœ¨ `MainWindow.__init__()` ä¸­ï¼š
   ```python
   self.data_ch5 = deque([0]*self.plot_len, maxlen=self.plot_len)
   self.current_coeffs.append(na)  # åœ¨ SerialThread ä¸­ä¹Ÿè¦åŒæ­¥ä¿®æ”¹
   ```

4. **æ·»åŠ ç»˜å›¾åŒºåŸŸ** - åœ¨ `MainWindow.init_ui()` ä¸­ï¼š
   ```python
   self.graph_widget.nextRow()
   self.plot5 = self.graph_widget.addPlot(title="CH5")
   self.curve5 = self.plot5.plot(pen='r')  # çº¢è‰²
   ```

5. **æ›´æ–°ç»˜å›¾é€»è¾‘** - åœ¨ `MainWindow.update_plot()` ä¸­ï¼š
   ```python
   self.data_ch5.extend(new_processed_np[:, 4])
   self.curve5.setData(np.array(self.data_ch5))
   
   # åŒæ—¶æ›´æ–°ä¿å­˜é€»è¾‘
   line = f"{row_data[0]:.8f}, {row_data[1]:.8f}, {row_data[2]:.8f}, {row_data[3]:.8f}, {row_data[4]:.8f}\n"
   ```

### 6.2 ä¿®æ”¹é€šä¿¡åè®®

#### ä¿®æ”¹å¸§ç»“æ„

```python
# ç¤ºä¾‹ï¼šå°† CH3/CH4 æ‰©å±•ä¸º 9 å­—èŠ‚
val3 = int.from_bytes(frame[25:34], byteorder='big', signed=False)  # æ”¹ä¸º9å­—èŠ‚
val4 = int.from_bytes(frame[34:43], byteorder='big', signed=False)  # æ”¹ä¸º9å­—èŠ‚
FRAME_LEN = 44  # ç›¸åº”è°ƒæ•´å¸§é•¿åº¦
```

âš ï¸ **æ³¨æ„**ï¼šä¿®æ”¹åè®®éœ€è¦åŒæ­¥æ›´æ–°ä¸‹ä½æœºå›ºä»¶ï¼

#### ä¿®æ”¹ä¸‹è¡Œåè®®

```python
# è°ƒæ•´å›ºå®šå­—èŠ‚ä½ç½®
fixed_vals = {
    0: 0xFF,  # æ–°å¢å›ºå®šå¸§å¤´
    1: 0x24,
    # ... å…¶ä»–å›ºå®šå­—èŠ‚
}

# ä¿®æ”¹ç½‘æ ¼åˆ—æ•°
MAX_COLS = 6  # æ”¹ä¸º6åˆ—æ˜¾ç¤º
```

#### ä¿®æ”¹æ•°æ®å¤„ç†ç®—æ³•

```python
def calculate_coeffs(g):
    """è‡ªå®šä¹‰ç³»æ•°è®¡ç®—"""
    # ç¤ºä¾‹ï¼šçº¿æ€§å…³ç³»
    nf = 1000.0 * (2 ** g)
    na = 500.0 * (2 ** g)
    return nf, na
```

### 6.3 ç•Œé¢å®šåˆ¶

#### è°ƒæ•´å¸ƒå±€

```python
# æ§åˆ¶é¢æ¿å®½åº¦
scroll_area.setMaximumWidth(450)  # å¢å®½åˆ° 450px

# æ³¢å½¢åŒºåŸŸè¡Œæ•°ï¼ˆæ”¹ä¸º2x2å¸ƒå±€ï¼‰
self.graph_widget.addPlot(...)  # CH1
self.graph_widget.addPlot(...)  # CH2ï¼ˆä¸æ¢è¡Œï¼‰
self.graph_widget.nextRow()     # æ¢è¡Œ
self.graph_widget.addPlot(...)  # CH3
self.graph_widget.addPlot(...)  # CH4
```

#### æ ·å¼ä¿®æ”¹

**é¢œè‰²ä¸»é¢˜**ï¼š

```python
# æ§åˆ¶é¢æ¿èƒŒæ™¯è‰²
control_panel.setStyleSheet("background-color: #F5F5F5;")

# æŒ‰é’®æ ·å¼
self.btn_connect.setStyleSheet("""
    QPushButton {
        background-color: #4CAF50;
        color: white;
        border-radius: 5px;
        padding: 8px;
    }
    QPushButton:hover {
        background-color: #45a049;
    }
""")

# æ³¢å½¢ç»˜å›¾èƒŒæ™¯è‰²
self.graph_widget.setBackground('#1E1E1E')  # æ·±ç°è‰²èƒŒæ™¯
```

**ç»˜å›¾é¢œè‰²**ï¼š

| é¢œè‰²ä»£ç  | é¢œè‰²åç§° | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|
| `'y'` | é»„è‰² | é«˜å¯¹æ¯”åº¦ |
| `'g'` | ç»¿è‰² | è‡ªç„¶ä¿¡å· |
| `'c'` | é’è‰² | å†·è‰²è°ƒ |
| `'m'` | æ´‹çº¢ | æš–è‰²è°ƒ |
| `'r'` | çº¢è‰² | è­¦å‘Š/é”™è¯¯ |
| `'b'` | è“è‰² | å†·é™ä¿¡å· |
| `'w'` | ç™½è‰² | é«˜äº®æ˜¾ç¤º |
| `(255,100,50)` | RGB | è‡ªå®šä¹‰é¢œè‰² |

#### æ·»åŠ æ–°æ§ä»¶

```python
# åœ¨ä¸²å£è¿æ¥ç»„ä¸­æ·»åŠ çŠ¶æ€æŒ‡ç¤ºç¯
self.status_label = QLabel("â— æœªè¿æ¥")
self.status_label.setStyleSheet("color: red; font-weight: bold;")
serial_layout.addWidget(self.status_label)

# è¿æ¥æˆåŠŸåæ›´æ–°
self.status_label.setText("â— å·²è¿æ¥")
self.status_label.setStyleSheet("color: green; font-weight: bold;")
```

### 6.4 æ€§èƒ½è°ƒä¼˜

#### åˆ·æ–°ç‡è°ƒæ•´

```python
# ä½æ€§èƒ½è®¾å¤‡ï¼šé™ä½åˆ·æ–°ç‡
self.timer.start(100)  # 100ms = 10 FPS

# é«˜æ€§èƒ½è®¾å¤‡ï¼šæé«˜åˆ·æ–°ç‡
self.timer.start(20)   # 20ms = 50 FPS

# æƒè¡¡å»ºè®®ï¼š
# - 50ms (20 FPS): æµç•…ä¸”çœCPU âœ… æ¨è
# - 33ms (30 FPS): è¾ƒæµç•…ï¼ŒCPUå ç”¨ä¸­ç­‰
# - 16ms (60 FPS): éå¸¸æµç•…ï¼Œé«˜CPUå ç”¨
```

#### æ•°æ®ç¼“å†²åŒºå¤§å°

```python
# çŸ­æ—¶è§‚å¯Ÿï¼šå‡å°‘å†…å­˜ä½¿ç”¨
self.plot_len = 500  # åªæ˜¾ç¤º500ä¸ªç‚¹

# é•¿æ—¶è¶‹åŠ¿ï¼šå¢åŠ å†å²é•¿åº¦
self.plot_len = 5000  # æ˜¾ç¤º5000ä¸ªç‚¹

# å†…å­˜ä¼°ç®—ï¼š4é€šé“ Ã— 5000ç‚¹ Ã— 8å­—èŠ‚ â‰ˆ 160 KB
```

#### ç»˜å›¾ä¼˜åŒ–

```python
# å¯ç”¨ OpenGL ç¡¬ä»¶åŠ é€Ÿï¼ˆéœ€è¦ OpenGL æ”¯æŒï¼‰
import pyqtgraph as pg
pg.setConfigOptions(useOpenGL=True)
pg.setConfigOptions(enableExperimental=True)

# é™é‡‡æ ·æ˜¾ç¤ºï¼ˆæ•°æ®é‡è¶…å¤§æ—¶ï¼‰
self.curve1.setDownsampling(auto=True, method='peak')

# å…³é—­æŠ—é”¯é½¿ï¼ˆæå‡æ€§èƒ½ï¼‰
self.curve1.setAntialiasing(False)
```

### 6.5 æ•°æ®ä¿å­˜æ ¼å¼ä¿®æ”¹

#### æ·»åŠ æ—¶é—´æˆ³

```python
# åœ¨ MainWindow.__init__() ä¸­æ·»åŠ 
self.save_start_time = None

# åœ¨ start_save() ä¸­åˆå§‹åŒ–
self.save_start_time = time.time()

# åœ¨ update_plot() ä¸­ä¿®æ”¹ä¿å­˜é€»è¾‘
if self.is_saving and self.save_file:
    for row_data in new_processed:
        elapsed_time = time.time() - self.save_start_time
        line = f"{elapsed_time:.6f},{row_data[0]:.8f},{row_data[1]:.8f},{row_data[2]:.8f},{row_data[3]:.8f}\n"
        self.save_file.write(line)
```

**æ ¼å¼**ï¼š
```csv
Time(s),CH1,CH2,CH3,CH4
0.000000,0.12345678,0.23456789,0.34567890,0.45678901
0.050123,0.12345679,0.23456790,0.34567891,0.45678902
```

#### ä¿å­˜ä¸ºäºŒè¿›åˆ¶æ ¼å¼ï¼ˆæ›´é«˜æ•ˆï¼‰

```python
import struct

# ä¿®æ”¹ start_save()
self.save_file = open(filename, 'wb')  # äºŒè¿›åˆ¶å†™å…¥

# ä¿®æ”¹ update_plot() ä¿å­˜é€»è¾‘
for row_data in new_processed:
    # æ‰“åŒ…ä¸º 4 ä¸ªåŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ8å­—èŠ‚Ã—4=32å­—èŠ‚ï¼‰
    binary_data = struct.pack('dddd', *row_data)
    self.save_file.write(binary_data)
```

**è¯»å–ç¤ºä¾‹**ï¼š
```python
import struct

with open('data.bin', 'rb') as f:
    while chunk := f.read(32):  # æ¯æ¬¡è¯»å–32å­—èŠ‚
        ch1, ch2, ch3, ch4 = struct.unpack('dddd', chunk)
        print(ch1, ch2, ch3, ch4)
```

#### ä¿å­˜ä¸º NumPy æ ¼å¼

```python
import numpy as np

# æ–¹æ¡ˆ1ï¼šä½¿ç”¨ numpy.save (å‹ç¼©æ•ˆç‡é«˜)
if self.is_saving:
    all_data = np.array(new_processed)
    np.save(self.save_file, all_data)

# æ–¹æ¡ˆ2ï¼šç´¯ç§¯åä¸€æ¬¡æ€§ä¿å­˜
self.accumulated_data.extend(new_processed)  # åœ¨ç±»ä¸­ç»´æŠ¤åˆ—è¡¨

# åœæ­¢æ—¶ä¿å­˜
def stop_save(self):
    if self.accumulated_data:
        np.savetxt('data.csv', self.accumulated_data, delimiter=',')
        # æˆ–
        np.save('data.npy', np.array(self.accumulated_data))
```

### 6.6 å®Œå–„å¸§æ ¡éªŒï¼ˆæ·»åŠ å¸§å°¾ 0xBBï¼‰

å½“å‰ç¨‹åºé‡‡ç”¨å•å¸§å¤´ (`0xAA`) æ£€æµ‹æœºåˆ¶å³å¯æ»¡è¶³åŸºæœ¬è¿è¡Œéœ€æ±‚ï¼Œå¼•å…¥å¸§å°¾ (`0xBB`) æ ¡éªŒå¯æ˜¾è‘—æå‡é€šä¿¡é“¾è·¯çš„å¯é æ€§ä¸æŠ—å¹²æ‰°èƒ½åŠ›ã€‚

**å•å¸§å¤´æ£€æµ‹çš„å¯è¡Œæ€§åˆ†æ**
1. **ç»Ÿè®¡æ¦‚ç‡**ï¼šåœ¨è¿ç»­æ•°æ®æµä¸­ï¼Œ`0xAA` ä½œä¸ºå¸§å¤´å…·æœ‰å›ºå®šå‘¨æœŸæ€§ã€‚å°½ç®¡æ•°æ®åŸŸå¯èƒ½å¶å‘ `0xAA`ï¼Œä½†éå‘¨æœŸæ€§çš„ä¼ªå¸§å¤´ä¼šè¢«åç»­é€»è¾‘è‡ªåŠ¨è¿‡æ»¤ã€‚
2. **åº”ç”¨å®¹é”™**ï¼šæ³¢å½¢æ˜¾ç¤ºåœºæ™¯å¯¹å¶å‘ä¸¢å¸§å…·æœ‰ä¸€å®šå®¹å¿åº¦ï¼Œç¨‹åºå…·å¤‡è‡ªåŠ¨é‡åŒæ­¥èƒ½åŠ›ã€‚

**å¦‚ä½•æ·»åŠ å¸§å°¾æ ¡éªŒï¼Ÿ**

åœ¨ `SerialThread.run()` æ–¹æ³•ä¸­ä¿®æ”¹è§£æé€»è¾‘ï¼š

```python
# ä¿®æ”¹å‰
if self.buffer[0] == 0xAA:
    frame = self.buffer[0:FRAME_LEN]
    # ... è§£æé€»è¾‘ ...

# ä¿®æ”¹å
if self.buffer[0] == 0xAA:
    # æ£€æŸ¥ç¼“å†²åŒºé•¿åº¦æ˜¯å¦è¶³å¤Ÿ
    if len(self.buffer) >= FRAME_LEN:
        # æ£€æŸ¥å¸§å°¾ (ç´¢å¼• 39)
        if self.buffer[FRAME_LEN-1] == 0xBB:
            frame = self.buffer[0:FRAME_LEN]
            # ... åŸæœ‰è§£æé€»è¾‘ ...
            del self.buffer[0:FRAME_LEN] # ç§»é™¤å¤„ç†è¿‡çš„å¸§
        else:
            # å¸§å¤´åŒ¹é…ä½†å¸§å°¾ä¸åŒ¹é…ï¼Œè¯´æ˜å¯èƒ½æ˜¯ä¼ªå¸§å¤´
            del self.buffer[0] # ä»…ç§»é™¤ä¸€ä¸ªå­—èŠ‚ï¼Œç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªå¸§å¤´
    else:
        # æ•°æ®ä¸å¤Ÿï¼Œç­‰å¾…æ›´å¤šæ•°æ®
        break 
else:
    del self.buffer[0]
```

### 6.7 æ•°æ®åˆ†æï¼ˆFFT ä¸ PSDï¼‰

åœ¨ `MainWindow` ç±»ä¸­é›†æˆé¢‘è°±åˆ†ææ¨¡å—ã€‚

#### 1. å¿«é€Ÿå‚…é‡Œå¶å˜æ¢ (FFT)

**FFT (å¿«é€Ÿå‚…é‡Œå¶å˜æ¢)**ï¼šç”¨äºæ—¶é¢‘åŸŸè½¬æ¢ï¼Œåˆ†æä¿¡å·é¢‘è°±ç‰¹å¾ã€‚

```python
import numpy as np

def calculate_fft(self, data_channel, fs):
    """
    è®¡ç®— FFT
    :param data_channel: é€šé“æ•°æ®åˆ—è¡¨ (å¦‚ self.data_ch1)
    :param fs: é‡‡æ ·é¢‘ç‡ (Hz)
    """
    n = len(data_channel)
    # 1. è®¡ç®— FFT
    fft_values = np.fft.rfft(data_channel)
    # 2. è®¡ç®—é¢‘ç‡è½´
    fft_freqs = np.fft.rfftfreq(n, d=1/fs)
    # 3. è®¡ç®—å¹…åº¦è°± (å½’ä¸€åŒ–)
    fft_magnitude = np.abs(fft_values) / n
    
    # ç»˜åˆ¶å»ºè®®ï¼šå¿½ç•¥ç›´æµåˆ†é‡ (ç´¢å¼•0)
    return fft_freqs[1:], fft_magnitude[1:]
```

#### 2. åŠŸç‡è°±å¯†åº¦ (PSD)

**PSD (åŠŸç‡è°±å¯†åº¦)**ï¼šè¡¨å¾ä¿¡å·åŠŸç‡éšé¢‘ç‡çš„åˆ†å¸ƒç‰¹æ€§ï¼Œç›¸è¾ƒäº FFT æ›´é€‚ç”¨äºéšæœºä¿¡å·åˆ†æã€‚

```python
from scipy import signal

def calculate_psd(self, data_channel, fs):
    """
    è®¡ç®— PSD (Welch æ–¹æ³•)
    :param data_channel: é€šé“æ•°æ®åˆ—è¡¨
    :param fs: é‡‡æ ·é¢‘ç‡
    """
    # nperseg å†³å®šäº†é¢‘ç‡åˆ†è¾¨ç‡
    f, Pxx = signal.welch(data_channel, fs, nperseg=256)
    return f, Pxx
```

**é›†æˆå»ºè®®**ï¼š
1. åœ¨ç•Œé¢ä¸Šæ·»åŠ  "é¢‘è°±åˆ†æ" æŒ‰é’®ã€‚
2. ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œå¼¹å‡ºä¸€ä¸ªæ–°çª—å£ (`QDialog` æˆ– `QMainWindow`)ã€‚
3. åœ¨æ–°çª—å£ä¸­ä½¿ç”¨ `pyqtgraph` ç»˜åˆ¶è®¡ç®—å‡ºçš„é¢‘åŸŸæ³¢å½¢ã€‚

---

## 7. å¸¸è§é—®é¢˜ä¸è°ƒè¯•

### 7.1 ä¸²å£è¿æ¥å¤±è´¥

**æ•…éšœç°è±¡**ï¼šç‚¹å‡»"æ‰“å¼€ä¸²å£"åå¼¹å‡ºé”™è¯¯æç¤º

**æ•…éšœæ’æŸ¥è¡¨**ï¼š

| å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| ç«¯å£å ç”¨ | å…³é—­å…¶ä»–ä¸²å£ç›‘æ§å·¥å…·ï¼ˆArduino IDEã€PuTTY ç­‰ï¼‰ |
| æ³¢ç‰¹ç‡å¤±é… | ç¡®è®¤ä¸‹ä½æœºæ³¢ç‰¹ç‡è®¾ç½®ä¸º **1000000 bps** |
| æƒé™ä¸è¶³ (Linux/macOS) | æ‰§è¡Œ `sudo usermod -a -G dialout $USER` å¹¶é‡æ–°ç™»å½• |
| é©±åŠ¨ç¼ºå¤± | å®‰è£…å¯¹åº”èŠ¯ç‰‡é©±åŠ¨ (CH340/CP2102/FTDI) |
| ç‰©ç†è¿æ¥å¼‚å¸¸ | æ›´æ¢é«˜å“è´¨æ•°æ®çº¿ï¼ˆæ’é™¤ä»…å……ç”µçº¿æï¼‰ |

**è°ƒè¯•æ–¹æ³•**ï¼š

```python
# åœ¨ SerialThread.open_port() ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—
try:
    self.serial_port.open()
    print(f"âœ… æˆåŠŸæ‰“å¼€ {port_name}")
    print(f"   æ³¢ç‰¹ç‡: {self.serial_port.baudrate}")
    print(f"   è¶…æ—¶: {self.serial_port.timeout}s")
except serial.SerialException as e:
    print(f"âŒ ä¸²å£é”™è¯¯: {e}")
except Exception as e:
    print(f"âŒ æœªçŸ¥é”™è¯¯: {type(e).__name__}: {e}")
```

### 7.2 æ•°æ®è§£æé”™è¯¯

**æ•…éšœç°è±¡**ï¼šæ³¢å½¢æ˜¾ç¤ºå¼‚å¸¸ï¼ˆå…¨é›¶ã€è·³å˜ã€é«˜é¢‘å™ªå£°ï¼‰

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥å¸§å¤´å¯¹é½**

   ```python
   # åœ¨ SerialThread.run() ä¸­æ·»åŠ 
   print(f"ç¼“å†²åŒºå‰10å­—èŠ‚: {self.buffer[:10].hex()}")
   if self.buffer[0] != 0xAA:
       print(f"âš ï¸ å¸§å¤´é”™è¯¯: 0x{self.buffer[0]:02X} (æœŸæœ› 0xAA)")
   ```

2. **éªŒè¯æ•°æ®é•¿åº¦**

   ```python
   if len(frame) != FRAME_LEN:
       print(f"âŒ å¸§é•¿åº¦é”™è¯¯: {len(frame)} (æœŸæœ› {FRAME_LEN})")
   ```

3. **æ‰“å°åŸå§‹æ•°æ®**

   ```python
   print(f"åŸå§‹å¸§: {frame.hex(' ').upper()}")
   print(f"CH1åŸå§‹å€¼: {val1}, å¤„ç†å: {val1/self.current_coeffs[0]}")
   ```

4. **æ£€æŸ¥ç³»æ•°æ˜¯å¦æ›´æ–°**

   ```python
   print(f"å½“å‰ç³»æ•°: NF={self.current_coeffs[0]:.2e}, NA={self.current_coeffs[2]:.2e}")
   ```

### 7.3 ç•Œé¢æ— å“åº”/å¡é¡¿

**æ•…éšœç°è±¡**ï¼šç•Œé¢å¡é¡¿ã€æ•°æ®æ›´æ–°å»¶è¿Ÿã€CPU å ç”¨ç‡è¿‡é«˜

**ä¼˜åŒ–ç­–ç•¥**ï¼š

1. **é™ä½åˆ·æ–°ç‡**
   ```python
   self.timer.start(100)  # ä»50msæ”¹ä¸º100ms
   ```

2. **å‡å°‘æ˜¾ç¤ºç‚¹æ•°**
   ```python
   self.plot_len = 500  # ä»1000æ”¹ä¸º500
   ```

3. **æ‰¹é‡å¤„ç†ä¼˜åŒ–**
   ```python
   # è®¾ç½®æ‰¹é‡é˜ˆå€¼
   if len(self.temp_buffer) < 10:  # ç§¯ç´¯10ä¸ªæ•°æ®åŒ…å†æ›´æ–°
       return
   ```

4. **é™ä½æ•°æ®ç‡ï¼ˆç¡¬ä»¶å±‚é¢ï¼‰**
   - é€‰æ‹©è¾ƒä½çš„é‡‡æ ·é¢‘ç‡ï¼ˆ250Hz è€Œé 2KHzï¼‰
   - å‡å°‘æ•°æ®å‘é€é¢‘ç‡

### 7.4 æ•°æ®ä¿å­˜å¤±è´¥

**æ•…éšœç°è±¡**ï¼šæ–‡ä»¶æŸåã€æ•°æ®ä¸¢å¤±ã€ä¿å­˜æ„å¤–ä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **æ·»åŠ å¼‚å¸¸å¤„ç†**

   ```python
   def update_plot(self):
       if self.is_saving and self.save_file:
           try:
               for row_data in new_processed:
                   line = f"{row_data[0]:.8f}, {row_data[1]:.8f}, {row_data[2]:.8f}, {row_data[3]:.8f}\n"
                   self.save_file.write(line)
               self.save_file.flush()  # âœ… å¼ºåˆ¶å†™å…¥ç£ç›˜
           except IOError as e:
               print(f"âŒ æ–‡ä»¶å†™å…¥å¤±è´¥: {e}")
               QMessageBox.critical(self, "é”™è¯¯", f"ä¿å­˜å¤±è´¥: {e}")
               self.stop_save()
   ```

2. **ç¡®ä¿æ–‡ä»¶æ­£ç¡®å…³é—­**

   ```python
   def closeEvent(self, event):
       """ç¨‹åºå…³é—­å‰çš„æ¸…ç†"""
       self.stop_save()  # âœ… ç¡®ä¿æ–‡ä»¶å…³é—­
       self.serial_thread.close_port()
       super().closeEvent(event)
   ```

3. **å®šæœŸåˆ·æ–°ç¼“å†²åŒº**

   ```python
   # æ¯100ä¸ªæ•°æ®åŒ…åˆ·æ–°ä¸€æ¬¡
   self.save_count = 0

   if self.is_saving:
       self.save_count += len(new_processed)
       if self.save_count >= 100:
           self.save_file.flush()
           self.save_count = 0
   ```

### 7.5 æ•°æ®ä¸¢å¤±é—®é¢˜

**æ•…éšœç°è±¡**ï¼šæ³¢å½¢ä¸è¿ç»­ã€æ•°æ®å¸§ç¼ºå¤±

**åŸå› åˆ†æ**ï¼š

- ä¸²å£æ¥æ”¶ç¼“å†²åŒºæº¢å‡º
- æ•°æ®å¤„ç†é€Ÿç‡ä½äºæ¥æ”¶é€Ÿç‡
- ä¸»çº¿ç¨‹é˜»å¡å¯¼è‡´äº‹ä»¶å¾ªç¯åœæ»

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **å¢åŠ ä¸²å£ç¼“å†²åŒº**
   ```python
   self.serial_port.set_buffer_size(rx_size=4096*4)  # å¢åŠ æ¥æ”¶ç¼“å†²
   ```

2. **ä¼˜åŒ–æ•°æ®å¤„ç†**
   ```python
   # ä½¿ç”¨æ›´é«˜æ•ˆçš„åˆ‡ç‰‡æ“ä½œ
   vals = [
       int.from_bytes(frame[3:14], 'big'),
       int.from_bytes(frame[14:25], 'big'),
       int.from_bytes(frame[25:32], 'big'),
       int.from_bytes(frame[32:39], 'big')
   ]
   processed = [v/c for v, c in zip(vals, self.current_coeffs)]
   ```

3. **ç›‘æ§é˜Ÿåˆ—é•¿åº¦**
   ```python
   if len(self.temp_buffer) > 100:
       print(f"âš ï¸ ç¼“å†²åŒºç§¯å‹: {len(self.temp_buffer)} åŒ…")
   ```

---

## 8. ç³»ç»Ÿé™åˆ¶

### 8.1 åè®®çº¦æŸ

| é™åˆ¶é¡¹ | è¯´æ˜ | å½±å“ |
|--------|------|------|
| **å›ºå®šå¸§é•¿** | æ•°æ®å¸§å¿…é¡»ä¸¥æ ¼ä¸º 40 å­—èŠ‚ | é€šé“æ‰©å±•éœ€åŒæ­¥æ›´æ–°å›ºä»¶åè®® |
| **æ— å·®é”™æ§åˆ¶** | ç¼ºä¹ CRC æˆ–æ ¡éªŒå’Œæœºåˆ¶ | å¼ºå¹²æ‰°ç¯å¢ƒä¸‹å¯èƒ½äº§ç”Ÿè„æ•°æ® |
| **æ— é‡ä¼ æœºåˆ¶** | æ•°æ®ä¼ è¾“é‡‡ç”¨ UDP å¼ä¸å¯é æ¨¡å¼ | ä¸é€‚ç”¨äºå…³é”®æ§åˆ¶ä¿¡å·ä¼ è¾“ |
| **å•å‘é…ç½®** | ç¼ºä¹ä¸‹ä½æœº ACK ç¡®è®¤æœºåˆ¶ | æ— æ³•éªŒè¯é…ç½®æŒ‡ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ |

### 8.2 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡é¡¹ | å…¸å‹å€¼/è¯´æ˜ | ç“¶é¢ˆåˆ†æ |
|--------|----------|------|
| **æœ€å¤§ååé‡** | ~50 KB/s | å—é™äº Python GIL åŠä¸²å£é©±åŠ¨å¼€é”€ |
| **å®æ—¶å»¶è¿Ÿ** | ~50ms | å–å†³äº PyQt äº‹ä»¶å¾ªç¯åŠå®šæ—¶å™¨ç²¾åº¦ |
| **CPU è´Ÿè½½** | ä¸­ç­‰ (10-30%) | å®æ—¶ç»˜å›¾æ¸²æŸ“ä¸æµ®ç‚¹è¿ç®—å¼€é”€ |
| **å†…å­˜å ç”¨** | ~50-100 MB | PyQt5 æ¡†æ¶ä¸ pyqtgraph ç»„ä»¶åŸºç¡€å¼€é”€ |

### 8.3 å¹³å°é™åˆ¶

| å¹³å° | é™åˆ¶ | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| **Linux** | éœ€è¦ä¸²å£æƒé™ | åŠ å…¥ dialout ç”¨æˆ·ç»„ |
| **macOS** | USBä¸²å£è®¾å¤‡åè¾ƒé•¿ | å®Œæ•´æ˜¾ç¤ºè®¾å¤‡è·¯å¾„ |
| **Windows** | COMç«¯å£å·é™åˆ¶ | ä½¿ç”¨è®¾å¤‡ç®¡ç†å™¨é‡æ–°åˆ†é… |

---

## 9. å¼€å‘å»ºè®®

### 9.1 ä»£ç æ”¹è¿›

#### æ·»åŠ æ—¥å¿—ç³»ç»Ÿ

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.FileHandler('serial_scope.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

# ä½¿ç”¨æ—¥å¿—æ›¿ä»£ print
logger.info(f"ä¸²å£å·²æ‰“å¼€: {port_name}")
logger.warning(f"ç¼“å†²åŒºç§¯å‹: {len(self.temp_buffer)}")
logger.error(f"è§£æå¤±è´¥: {e}")
```

#### æ·»åŠ é…ç½®æ–‡ä»¶

```python
import json

# config.json
{
    "serial": {
        "baud_rate": 1000000,
        "timeout": 0.1
    },
    "ui": {
        "plot_length": 1000,
        "refresh_rate_ms": 50,
        "window_width": 1280,
        "window_height": 850
    },
    "colors": {
        "ch1": "y",
        "ch2": "g",
        "ch3": "c",
        "ch4": "m"
    }
}

# åŠ è½½é…ç½®
class Config:
    def __init__(self):
        with open('config.json', 'r') as f:
            self.data = json.load(f)
    
    def get(self, *keys):
        result = self.data
        for key in keys:
            result = result[key]
        return result

config = Config()
BAUD_RATE = config.get('serial', 'baud_rate')
```

#### å•å…ƒæµ‹è¯•

```python
import unittest

class TestDataProcessing(unittest.TestCase):
    def test_calculate_coeffs(self):
        """æµ‹è¯•ç³»æ•°è®¡ç®—"""
        nf, na = calculate_coeffs(0)
        self.assertAlmostEqual(nf, 4.70e+16, delta=1e15)
        self.assertAlmostEqual(na, 1.68e+07, delta=1e6)
    
    def test_frame_parsing(self):
        """æµ‹è¯•æ•°æ®å¸§è§£æ"""
        frame = bytearray([0xAA] + [0]*39)
        # è®¾ç½® CH1 æ•°æ®ï¼ˆå­—èŠ‚3-13ï¼‰
        frame[3:14] = (12345).to_bytes(11, 'big')
        
        val = int.from_bytes(frame[3:14], 'big')
        self.assertEqual(val, 12345)

if __name__ == '__main__':
    unittest.main()
```

### 9.2 åŠŸèƒ½æ‰©å±•å»ºè®®

#### æ•°æ®å›æ”¾åŠŸèƒ½

```python
class PlaybackThread(QThread):
    """ä»æ–‡ä»¶è¯»å–æ•°æ®å¹¶æ¨¡æ‹Ÿå®æ—¶æ’­æ”¾"""
    data_signal = pyqtSignal(list)
    
    def __init__(self, filename):
        super().__init__()
        self.filename = filename
        self.is_playing = True
    
    def run(self):
        with open(self.filename, 'r') as f:
            f.readline()  # è·³è¿‡è¡¨å¤´
            for line in f:
                if not self.is_playing:
                    break
                values = [float(x) for x in line.strip().split(',')]
                self.data_signal.emit(values)
                time.sleep(0.05)  # æ¨¡æ‹Ÿ50msé—´éš”
```

#### æ•°æ®åˆ†æåŠŸèƒ½

```python
from scipy import signal

def add_fft_plot(self):
    """æ·»åŠ FFTé¢‘è°±æ˜¾ç¤º"""
    self.fft_plot = self.graph_widget.addPlot(title="CH1 FFT")
    self.fft_curve = self.fft_plot.plot(pen='y')
    
    # åœ¨ update_plot() ä¸­è®¡ç®—FFT
    fft_data = np.fft.rfft(self.data_ch1)
    fft_freq = np.fft.rfftfreq(len(self.data_ch1), d=1/sample_rate)
    self.fft_curve.setData(fft_freq, np.abs(fft_data))
```

#### è§¦å‘åŠŸèƒ½

```python
def check_trigger(self, data):
    """æ£€æµ‹è§¦å‘æ¡ä»¶"""
    if self.trigger_enabled:
        if data > self.trigger_level and self.last_data <= self.trigger_level:
            # ä¸Šå‡æ²¿è§¦å‘
            self.trigger_event.emit()
            self.capture_waveform()
```

### 9.3 æ–‡æ¡£æ”¹è¿›

- ğŸ“ æ·»åŠ  **API å‚è€ƒæ–‡æ¡£** (ä½¿ç”¨ Sphinx æˆ– MkDocs)
- ğŸ¥ å½•åˆ¶ **è§†é¢‘æ•™ç¨‹**
- ğŸ–¼ï¸ æ·»åŠ  **ç•Œé¢æˆªå›¾å’Œæµç¨‹å›¾**
- ğŸŒ æä¾› **è‹±æ–‡ç‰ˆæ–‡æ¡£**

### 9.4 é¡¹ç›®ç®¡ç†

```
serial_scope/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ serial_thread.py    # ä¸²å£çº¿ç¨‹
â”‚   â”œâ”€â”€ main_window.py      # ä¸»çª—å£
â”‚   â”œâ”€â”€ protocol.py         # åè®®å®šä¹‰
â”‚   â””â”€â”€ utils.py            # å·¥å…·å‡½æ•°
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_protocol.py
â”‚   â””â”€â”€ test_processing.py
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ user_guide.md
â”‚   â””â”€â”€ api_reference.md
â”œâ”€â”€ config.json
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ setup.py
â””â”€â”€ README.md
```

### 9.5 æ€§èƒ½ç›‘æ§

```python
import cProfile
import pstats

# æ€§èƒ½åˆ†æ
profiler = cProfile.Profile()
profiler.enable()

# ... è¿è¡Œä»£ç  ...

profiler.disable()
stats = pstats.Stats(profiler)
stats.sort_stats('cumulative')
stats.print_stats(20)  # æ˜¾ç¤ºå‰20ä¸ªè€—æ—¶å‡½æ•°
```

---

## ğŸ“š é™„å½•

### A. å¿«æ·é”®å»ºè®®

| å¿«æ·é”® | åŠŸèƒ½ | å®ç°æ–¹å¼ |
|--------|------|---------|
| `Ctrl+O` | æ‰“å¼€/å…³é—­ä¸²å£ | `QShortcut` |
| `Ctrl+S` | å¼€å§‹/åœæ­¢ä¿å­˜ | `QShortcut` |
| `Space` | æš‚åœ/ç»§ç»­åˆ·æ–° | æ§åˆ¶å®šæ—¶å™¨ |
| `Ctrl+R` | æ¸…ç©ºæ³¢å½¢æ•°æ® | æ¸…ç©º deque |

### B. ç›¸å…³èµ„æº

- **PySerial æ–‡æ¡£**: https://pyserial.readthedocs.io/
- **PyQt5 æ•™ç¨‹**: https://www.riverbankcomputing.com/static/Docs/PyQt5/
- **pyqtgraph ç¤ºä¾‹**: http://www.pyqtgraph.org/
- **ä¸²å£è°ƒè¯•å·¥å…·**: 
  - Windows: PuTTY, Realterm
  - Linux: minicom, screen
  - macOS: screen, CoolTerm

### C. è®¸å¯è¯

æœ¬é¡¹ç›®å»ºè®®ä½¿ç”¨ **MIT License** æˆ– **GPLv3**

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-05  
**ä½œè€…**: cuffephonic  
**è”ç³»æ–¹å¼**: cuffephonic@gmail.com

---

*æ„Ÿè°¢ä½¿ç”¨ Serial_Scope_SJTUï¼å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issueè‡³cuffephonic@gmail.comã€‚å…¶å®ç›´æ¥å–‚ç»™geminiä¹Ÿä¸æ˜¯ä¸è¡ŒXD*
